{% extends 'budget_tracker/base.html' %}

{% block title %}Login - Budget Tracker{% endblock %}

{% block nav_buttons %}
<a href="{% url 'register' %}" class="btn-primary px-6 py-2 rounded-full hover:shadow-lg transition-all duration-300">Register</a>
{% endblock %}

{% block content %}
<div class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8 mt-16 transform transition-all duration-300 hover:shadow-2xl">
    <h2 class="text-3xl font-extrabold text-center mb-8 text-gray-900">Login to Your Account</h2>
    <form id="login-form" class="space-y-6">
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Username or Email</label>
            <input type="text" id="login-username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" required placeholder="Enter your username or email" title="Username or Email">
        </div>
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
            <div class="relative">
                <input type="password" id="login-password" class="w-full px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" required placeholder="Enter your password" title="Password">
                <button type="button" id="toggle-password" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500 hover:text-gray-700 focus:outline-none" title="Toggle password visibility">
                    <svg id="eye-closed" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
                    </svg>
                    <svg id="eye-open" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                </button>
            </div>
        </div>
        <button type="submit" class="w-full btn-primary px-6 py-3 rounded-full hover:shadow-lg transition-all duration-300">Login</button>
        <p class="mt-4 text-center text-sm text-gray-600">
            Don't have an account? 
            <a href="{% url 'register' %}" class="text-blue-600 hover:text-blue-800 font-medium">Register here</a>
        </p>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check if user is already logged in
        const authToken = localStorage.getItem('authToken');
        if (authToken) {
            window.location.href = '/dashboard/';
            return;
        }
        
        // form handler
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        
        // password toggle
        setupPasswordToggle();
    });

    function setupPasswordToggle() {
        const toggleButton = document.getElementById('toggle-password');
        const passwordInput = document.getElementById('login-password');
        const eyeClosed = document.getElementById('eye-closed');
        const eyeOpen = document.getElementById('eye-open');

        toggleButton.addEventListener('click', function() {
            const isPassword = passwordInput.type === 'password';
            
            // Toggle input type
            passwordInput.type = isPassword ? 'text' : 'password';
            
            // Toggle eye icons
            if (isPassword) {
                eyeClosed.classList.add('hidden');
                eyeOpen.classList.remove('hidden');
            } else {
                eyeClosed.classList.remove('hidden');
                eyeOpen.classList.add('hidden');
            }
        });
    }

    async function handleLogin(e) {
        e.preventDefault();
        
        const loginField = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        
        // Determine if the input is an email or username
        const isEmail = loginField.includes('@');
        
        const loginData = {
            password: password
        };
        
        // Add the appropriate field based on input type
        if (isEmail) {
            loginData.email = loginField;
        } else {
            loginData.username = loginField;
        }
        
        try {
            const data = await apiCall('/auth/login/', {
                method: 'POST',
                body: JSON.stringify(loginData)
            });
            
            authToken = data.token;
            localStorage.setItem('authToken', authToken);
            currentUser = data.user;
            
            showToast('Login successful! âœ…', 'success');
            
            // Redirect to dashboard after short delay
            setTimeout(() => {
                window.location.href = '/dashboard/';
            }, 1000);
            
        } catch (error) {
            showToast('Login failed: ' + error.message, 'error');
        }
    }
</script>
{% endblock %}